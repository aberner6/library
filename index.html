<!DOCTYPE html>
<meta charset="utf-8">
<head>
<!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans:300&subset=latin,latin-ext' rel='stylesheet' type='text/css'>



<link rel="stylesheet" id="googlefonts_heading-css" href="'http://fonts.googleapis.com/css?family=Open+Sans:300&subset=latin,latin-ext'&amp;ver=3.8.1" type="text/css" media="all">

 -->


<link href="css/style.css" rel="stylesheet" type="text/css" /> 

<link href="css/tipsy.css" rel="stylesheet" type="text/css" /> 
	</head>
	<style>
</style>
<script type="text/javascript" src="js/lib/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="js/lib/jquery.tipsy.js"></script>
<script type="text/javascript" src="js/lib/d3.min.js"></script>
<!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<!-- <script type="text/javascript" src="js/lib/intro.js"></script> -->
<script type="text/javascript" src="js/lib/jquery.hoverIntent.js"></script>
<body>

<!-- <div class = "tipsy tipsy-ne" style="top:41px; left:918px; display: none; opacity:0.7;">
<div class="tipsy-arrow tipsy-arrow-n"></div>
<div class="tipsy-inner"></div>
</div> -->





<div id = "container"></div>
	<div id="title">Interdisciplinary </br> Browser</div>
	<div id="clearAll">CLEAR
	</div>

<!-- <circle class="circlePlotted" cx="718.5" cy="368.5" r="450" fill="none" stroke="lightgray" stroke-width="60" style="
    stroke-opacity: .2;
"></circle>
 -->


<div id = "exitGraph">
<img src="exitGraph.png" width="13" height="13">
</div>
<div id = "graphIcon">
<img src="graphs.png" width="20" height="20">
</div>
<div class = "outerCircleText"></div>
<div id = "hoverbox"></div>
<div class = "listBooks"></div>
<div class = "subjectText"></div>
<div id = "booksColumn">
<img src="books.png" width="20" height="20">
</div>
<div id = "exit">
<img src="exit.png" width="13" height="13">
</div>

<div id="inner">
<div class = "thisArrow"></div>
</div>
<!-- <div class = "innerText" style="top:41px; left:918px;"></div> -->


<div class="center">
		<div id="skip">Skip Intro</div>

	<div class="intro"> 
	<div id="introNav">
		<img src="forwardNav.png" width="15" height="15">
	</div>
	<div id="intro1" style="display: none; opacity: 0;">
				<p>The Multidisciplinary Browser</p>
				<p>All libraries, top 25 subjects referenced, returning 400 entries</p>
	</div>
	<div id="intro2" style="display: none; opacity: 0;">
				<p>These ahhhhh</p>
	</div>
	<div id="intro3" style="display: none; opacity: 0;">
				<p>This does this</p>
	</div>
</div>
</div>

<div class="center">
	<div class="introZoom"> 
	<div id="intro4" style="display: none;">
				<p>Circles are placed on tiers according to how many subjects they are connected to.</p>
				<p>	This outermost tier is composed of circles connected to 2 subjects</p>
	</div>
	<div id="intro5" style="display: none;">
				<p>The next tier of circles are connected to 3 subjects</p>
	</div>
	<div id="intro6" style="display: none;">
				<p>4 subjects</p>
	</div>
	<div id="intro7" style="display: none;">
				<p>5 subjects</p>
	</div>
	<div id="intro8" style="display: none;">
				<p>And 6 subjects</p>
	</div>
	<div id="intro9" style="display: none;">
				<p>Each circle represents a collection of books related to a unique set of subjects</p>
	</div>
	<div id="intro10" style="display: none;">
				<p>Its size relates to how many books it contains - 1 in this case</p>
	</div>
	<div id="intro11" style="display: none;">
				<p>If you mouseover one circle, you will see lines spike out towards the related subjects</p>
	</div>
	<div id="intro12" style="display: none;">
				<p>And vice versa: </p>
				<p>If you click on subjects around the ring, you will see the collections of books that relate to those unique subjects</p>
	</div>
	<div id="intro13" style="display: none;">
				<p>Finally, open up the book list to view the titles.</p>
	</div>
	<div id="intro14" style="display: none;">
				<p>Click any to view its record in the Columbia Library</p>
	</div>
	</div>
</div>



	<div id="subline">About
	</div>
	<div id="about">The interdisciplinary browser was designed and developed by Jen Lowe and Annelie Berner</div>
<script type = "text/javascript">
		// if (d.loc<=6){
		// 	return "teal";
		// }
		// if (d.loc>6&&d.loc<=10){
		// 	return "lightgreen";
		// }
		// if (d.loc>10&&d.loc<=15){
		// 	return "lightblue";
		// }
		// if (d.loc>15&&d.loc<21){
		// 	return "blue";
		// }
var colors = 
// ["CC5C5A","CC5C5A","teal","teal","teal","teal","teal","lightgreen","lightgreen","lightgreen","lightgreen","lightblue","lightblue","lightblue","lightblue","lightblue","blue","blue","blue","blue","blue","blue"];
// "#FFCAA0","#FFCAA0","#FFCAA0","#FFCAA0"
//dark
// ["#5F8A2E","#5F8A2E",
// "#3C4EB4",
// "#2E848A",
// "#3C4EB4",
// "#3C4EB4",
// "#5F8A2E",
// "#848E2F",
// "#2D6886",
// "#2D6886",
// "#2D6886",
// "#2D4786",
// "#2E848A",
// "#8A5C2E",
// "#8A5C2E",
// "#2E848A",
// "#2D4786",
// "#2D4786",
// "#2D4786",
// "#2D6886",
// "#2D4786"]
//bright
// ["#FFDAA0","#FFDAA0",
// "#A0FFFF",
// "#A0FFFF",
// "#A0FFFF",
// "#A0FFFF",
// "#A0FFFF",
// "#45E9E9",
// "#45E9E9",
// "#45E9E9",
// "#45E9E9",
// "#ADB3FF",
// "#ADB3FF",
// "#ADB3FF",
// "#ADB3FF",
// "#ADB3FF",
// "#6F79F0",
// "#6F79F0",
// "#6F79F0",
// "#6F79F0",
// "#6F79F0",
// "#6F79F0"]
//not acqua
["#FFDAA0","#FFDAA0",
"#5ECBFF",
"#5ECBFF",
"#5ECBFF",
"#5ECBFF",
"#5ECBFF",
"#45E9E9",
"#45E9E9",
"#45E9E9",
"#45E9E9",
"#ADB3FF",
"#ADB3FF",
"#ADB3FF",
"#ADB3FF",
"#ADB3FF",
"#6F79F0",
"#6F79F0",
"#6F79F0",
"#6F79F0",
"#6F79F0",
"#6F79F0"]



var animateOpening = false;
	if (animateOpening) {
		d3.select("#container").style("pointer-events","none");
		d3.select("#intro1")
			.style("display", "block")
			.style("opacity", 1.0);
		$('#skip').fadeIn("slow");
var countProgress = 0;
	$('#introNav').on("click", function(){
		console.log(countProgress)
		countProgress++;
		if (countProgress==1){
			console.log(i)
			d3.select("#intro1")
			.transition().style("opacity", 0.0).style("display", "none");
			d3.select("#intro2")
			.style("display", "block").transition().duration(1000).style("opacity", 1.0);
			// portGroups.append("circle")
			// .attr("class", "point")
			// .attr("cx", 0)
			// .attr("cy", 0)
			// .attr("r", 0.01)
			// .transition()
			// .duration(5000)
			// .attr("r", radiusSmall)
			// .attr("opacity", portOnOpacity);
		}
		if (countProgress==2){
			console.log(i)
			d3.select("#intro2")
			.transition().style("opacity", 0.0).style("display", "none");
			d3.select("#intro3")
			.style("display", "block").transition().duration(1000).style("opacity", 1.0);			
		}
	})
	// $('.backNav').on("click", function(){
	// 	console.log(countProgress)
	// 	countProgress--;
	// 	if (countProgress==1){
	// 		console.log(i)
	// 		d3.select("#intro1")
	// 		.transition().style("opacity", 0.0).style("display", "none");
	// 		d3.select("#intro2")
	// 		.style("display", "block").transition().duration(1000).style("opacity", 1.0);
	// 	}
	// 	if (countProgress==2){
	// 		console.log(i)
	// 		d3.select("#intro2")
	// 		.transition().style("opacity", 0.0).style("display", "none");
	// 		d3.select("#intro3")
	// 		.style("display", "block").transition().duration(1000).style("opacity", 1.0);			
	// 	}
	// })
	$('#skip').on("click",function(){
		d3.select("#container").transition().style("opacity", 1.0);
		d3.selectAll("#intro1, #intro2, #intro3, #introNav, .intro").transition().style("opacity", 0.0).style("display", "none");
		// d3.select(".introNav").transition().style("opacity", 0.0).style("display", "none");
		$('#skip').fadeOut("fast");
				d3.select("#container").style("pointer-events","auto");
	})
}
else {
		d3.select("#container").transition().style("opacity", 1.0);
		d3.selectAll("#intro1, #intro2, #intro3, #introNav, .intro, .introZoom").transition().style("opacity", 0.0).style("display", "none");
		$('#skip').fadeOut("fast");	
				d3.select("#container").style("pointer-events","auto");

}
//NEXT THING IS CLICKING TO GET TO THE BOOKS HTML LINK

var freqscale = 5; //size of circles
var  MAX_LEVELS = 20; //number larger than number of levels of circles
// var conn_levels = [10, 10, 265, 210, 135, 75, 25, 10, 10, 10]; //how far away from the center each level is
var conn_levels = [12, 12, 264, 209, 137, 77,12]; //how far away from the center each level is
// var radius_levels = [0, 0, 240, 190, 125, 70, 15, 0, 0, 0]; //how far away from the center each level is
var outer_level = [0,265];
var radius_levels = [0, 0, 240, 190, 125, 70, 0, 0, 0, 0]; //how far away from the center each level is
// var subradius = 250; 
var MIN_LINE = 3.0; //length of the little ones
var TEXT_PAD_X = 5;
var TEXT_PAD_Y = 2;
var LEGEND_X_MARGIN = 20;
var LEGEND_SCALE = 0.0007;
// var littleLegend_SCALE = 0.0005;

//  Make an array of Subjects
var subjects;
//  Make an array of Connections
var connections;

var bcolor;
var subtext;
var hsubtext;
var concolor;
var hconcolor;
var legendconcolor;
  bcolor = "rgba(0, 0, 0, 255)";
  concolor = "rgba(210, 210, 210, 50)";
  hconcolor = "rgba(210, 210, 210, 100)";
  legendconcolor = "rgba(210, 210, 210, 75)";
  subtext = "rgba(150, 150, 150, 255)";
  hsubtext = "rgba(210, 210, 210, 255)";

var	windowWidth = window.outerWidth,
	windowHeight = window.innerHeight;

var boolSelected = 0;


var	width = window.outerWidth,
	height = window.innerHeight;



var svg = d3.select("#container")
    .append("svg")
	.attr({
      "width": "100%",
      "height": "95%",
  		})

var vis = svg
    .append('svg:g')
 	.attr("transform",
      "translate("+ 0 + "," + 0 + ")") //windowHeight/2















//  var width = document.getElementById("container").offsetWidth;
//  var height = document.getElementById("container").offsetHeight;



// // var zoom = d3.behavior.zoom()
// //     .center([0, 0])
// //     .scaleExtent([1, 10])
// //     .on("zoom", redraw);

// var svg = d3.select("#container")
//     .append("svg")
// 	.attr({
//       "width": "100%",
//       "height": "95%",
//   		})
//  	.attr("transform",
//       "translate("+ 0 + "," + 0 + ")")
//      .call(zoom);

// svg.attr("viewBox", "0 0 " + windowWidth + " " + windowHeight );


// var vis = svg
//     .append('svg:g')
//  	.attr("transform",
//       "translate("+ 0 + "," + windowHeight/2 + ")") //windowHeight/2

// var zoomingDoc = [];

// var zoom = d3.behavior.zoom()
//     // .center([0, 0])
//  .size([windowWidth, windowHeight])
//     .scaleExtent([1, 10])
//     .on("zoom", redraw);

// function redraw() {
//   console.log(d3.event.translate.x+"x");

//   console.log(d3.event.scale+"scale");
//   zoomingDoc.push(d3.event.scale);
//   // for (i=0; i<zoomingDoc.length; i++){
//   // if (zoomingDoc[i]<zoomingDoc[i-1] && zoomingDoc[i]<1.2){

// var trans = ([0, windowHeight/2])

//   vis.attr("transform",
//       "translate("+trans+ ")"
//       + " scale(" + d3.event.scale + ")");
// }









// function redraw() {
//   console.log(d3.event.translate+"translate");
//   console.log(d3.event.y+"translate x");

//   console.log(d3.event.scale+"scale");
//  vis.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
// }
loadBooks();

var subjX=[];
var subjY=[];
var subjText=[];
var sData = [];
var subjCode = [];
var subjTextInside = [];
var subjLoc = [];

var freqIs=[];
var item;

var subradius = 325;
var scaling = 1.1;

var firstLoad = -1;
var tigReggib = -1;
var clicked = 0;

var checkedIt = [];
var wasItSubj;
var storeClicks = {};

var scienceSubj;
var womenSubj;


var matching = 0;
var rectClicked = false;
var wordWidth = [];
function runOuterCircles(){
d3.tsv("subjects_top25.tsv", function(error, data) {
var jump = Math.PI*2/data.length; //    float jump = TWO_PI/(float
var angle = 0;

var text = vis.selectAll('.subjectText')
	.data(data)
	.enter().append("text")
	.attr("class",function(d,i){
		subjCode.push(d.subjCode);
		freqIs.push(d.freq);
		subjLoc.push(d.loc);
		subjTextInside.push(d.subject);
		subjX.push(width*.5+subradius*Math.cos(jump*(d.loc-1)));
		subjY.push(height*.5+subradius*Math.sin(jump*(d.loc-1))); 
		// if (d.subject==="Science"){
		// 	console.log(d.subject);
		// 	scienceSubj = i;
		// }
		// if (d.subject==="Women"){
		// 	womenSubj =i;
		// }
		return "subjectText"; 
	})
	.attr("x", function(d,i){ 
		if (subjX[i]>windowWidth/2){
			$(".subjectText").animate().css('text-align','left');

				return subjX[i]; 	
		}
		else {
		// 	return subjX[i]-(d.subject.length*3)-20;
		// }
			if (d.subject.length > 11){
			return subjX[i]-d.subject.length*3-55;			
			}
			if (d.subject.length<=11 &&d.subject.length>6){
				return subjX[i]-d.subject.length*3-25;			
			}
			else {
			return subjX[i]-d.subject.length*3-20;				
			}
		}
	})
	.attr("y", function(d,i){ 
		return subjY[i]; 
	})
	.text(function(d,i) { 
		return d.subject; 
	})
	.attr("fill", "black")

	.attr("opacity",1)

	.each(function(d) {
        d.width = this.getBBox().width;
      })
	.on("mouseover", function(d){


		d3.select(".surroundingPoints"+d.subjCode)
			.transition()
			.attr("stroke", colors[d.loc]);
		// d3.select(this).transition().style("border", "1 px solid darkgray");
	})
	// .on("mouseout", function(d){ 
	// })
	// .each(moveToFront)

	.on("click", function(d,i){
		count=0;
		var d = this.__data__;
		console.log(d);
		wasItSubj = d.subjCode;
		storeClicks[i] = storeClicks[i] ? storeClicks[i]+1 : 1; //now this is counters

		if(storeClicks[i]%2==1){ //if clicked ON
			console.log("clicked on"+storeClicks[i]%2)
			console.log("this is"+i)
			runLines(d.subjCode);
			checkedIt.push(d.subjCode);
			checked(checkedIt);
			matching = 0;

		d3.select(".surroundingPoints"+d.subjCode)
			.transition()
			.attr("y", subjY[i]-10)
			.attr("height",14);
			// .attr("stroke", colors[d.loc]);
		}

		if(storeClicks[i]%2==0){ //if unselected
			console.log("clicked off"+storeClicks[i]%2)
			d3.select(".surroundingPoints"+d.subjCode)
			.transition()
			.attr("y", subjY[i]+5)
			.attr("height",.1)
		//and remove that subject number
			for (c=0; c<checkedIt.length; c++){
				if (checkedIt[c]==d.subjCode){ // || 2 || 3 || 4
				checkedIt.splice(c,1);
			}
		}
booksChecked.length = 0;
bookColors.length = 0;

d3.selectAll("circle.inCircle"+checkedIndex)
	.transition()
	.attr("opacity",.1)
	.attr("fill","grey");
d3.selectAll(".checkedLinesOut").remove();
d3.selectAll(".mouseoverText").remove();
d3.selectAll(".innerText").remove();

checked(checkedIt);

removeRunnedLines(d.subjCode);

	}
});

// vis.selectAll("#intro3")
//     .attr("class","intro")
//     .attr("x",subjX[0])
//     .attr("y",subjY[0]);

var surroundingRects = vis.selectAll("surroundingPoints")
	.data(data)
	.enter().append("rect")
	.attr("class", function(d,i){ return "surroundingPoints"+d.subjCode; })
	.attr("x", function(d,i){

	// .attr("x", function(){ 
		if (subjX[i]>width/2){
				return subjX[i]-5; 	
		}
		else {
		// 	return subjX[i]-(d.subject.length*3)-20;
		// }
			if (d.subject.length > 11){
			return subjX[i]-d.subject.length*3-58;			
			}
			if (d.subject.length<=11 &&d.subject.length>6){
				return subjX[i]-d.subject.length*3-28;			
			}
			else {
			return subjX[i]-d.subject.length*3-23;				
			}
}

	})
	.attr("width", function(d,i){ 
		wordWidth.push(d.width);
		if (subjX[i]>width/2){
				return d.width+11;	
		}
		else{
		return d.width+8; //this.getBBox().width+3)
	}
	})














// 		if (subjX[i]>windowWidth/2){
// 				return subjX[i]; 	
// 		}
// 		else {
// 		// 	return subjX[i]-(d.subject.length*3)-20;
// 		// }
// 			if (d.subject.length > 11){
// 			return subjX[i]-d.subject.length*3-55;			
// 			}
// 			if (d.subject.length<=11 &&d.subject.length>6){
// 				return subjX[i]-d.subject.length*3-25;			
// 			}
// 			else {
// 			return subjX[i]-d.subject.length*3-20;				
// 			}
// }



// 	})
	.attr("y", function(d,i){  
			return height*.5+subradius*Math.sin(jump*(d.loc-1))+5;
	})
	// .attr("width", function(d,i){ 
	// 	wordWidth.push(d.width);
	// 	return d.width;
	// 	// return 0;
	// })
	.attr("height", .1)
	.attr("stroke-width","1px")
	.attr("fill","none")
	.attr("stroke", function(d,i){
		return "grey";//colors[d.loc];
	})

// var surroundingCircs = vis.selectAll("surroundingCircs")
// 	.data(data)
// 	.enter().append("circle")
// 	.attr("class", function(d,i){ return "surroundingCircs"+d.subjCode; })
// 	.attr("cx", function(d,i){
// 		if (subjX[i]>windowWidth/2){
// 				return subjX[i]; 	
// 		}
// 		else if (subjX[i]<windowWidth/2) {
// 			return subjX[i];//+wordWidth[i];

// 			// return subjX[i]-(d.subject.length*3)-20;
// 		}
// 	})
// 	.attr("cy", function(d,i){  
// 			return height*.5+subradius*Math.sin(jump*(d.loc-1))+5;
// 	})
// 	.attr("r",2)
// 	.attr("fill", function(d,i){
// 		return colors[d.loc];
// 	});






$('.subjectText').tipsy({ 
		gravity: 'nw', 
		html: true, 
		title: function() {
		  var d = this.__data__;
		var newNum = Math.round((d.freq) / 1000);
		var niceNum = numberWithCommas(newNum)+"k books";  
		  return niceNum;

		}
});
})
// if (subjCode.length>0 && r.length>0){
// 	console.log("prep lines?")
// 		prepLines();
// }
}
function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

var exitGraphsClicked = false;
$('#graphIcon').click(function(){
	if (exitGraphsClicked==false){
	makeGraphsBig();
}
if (exitGraphsClicked==true){
	justMakeGraphs();
}
		d3.select("#graphIcon").transition().style("display","none");	
		d3.select("#exitGraph").transition().style("display","block")

})

$('#exitGraph').click(function(){
	exitGraphsClicked = true;
	hideGraphs();
		d3.select("#exitGraph").transition().style("display","none");	
		d3.select("#graphIcon").transition().style("display","block");	
})

var mapLittleRect = d3.scale.linear()
	.domain([0, freqIs.length])
	.range([700,500]);

var maxFreq = d3.max(freqIs, function(d,i){return d; })

var legendMap = d3.scale.linear()
	.domain([0, maxFreq])
	.range([20,500]);

function hideGraphs(){
	d3.selectAll(".rectsAre, .textsAre")
	.transition()
	.attr("opacity",0)
}

function justMakeGraphs(){
	d3.selectAll(".rectsAre")
	.transition()
	.attr("opacity",.8)
	d3.selectAll(".textsAre")
	.transition()
	.attr("opacity",1)
}

var secondVis = svg
    .append('svg:g')
 	.attr("transform",
      "translate("+ 0 + "," + 0 + ")")
function makeGraphsBig(){
d3.tsv("subjects_top25.tsv", function(error, data) {
	var mapRect = d3.scale.linear()
	.domain([0, freqIs.length])
	.range([710,440]); //not 480

// if (freqIs.length>0){
var graphRects = secondVis.selectAll("rectsAre")
	.data(data)
	.enter()
	.append("rect")
	.attr("class", function(d){ return "rectsAre"})
	.attr("x", function(d){
		return 0;
	})
	.attr("y", function(d,i){
		return 0;
		// return mapRect(i); //if i want claims on bottom
	})
	.attr("width", function(d){
		return 0;
	})
	.attr("height",6)
	// .attr("fill","lightgray");
	.attr("fill", function(d,i){
		return colors[d.loc];
	})
	.attr("opacity",.8)
var graphText = secondVis.selectAll("textsAre")
	.data(data)
	.enter()
	.append("text")
	.attr("class", function(d){ return "textsAre"})
	.attr("x", function(d){
		0;
	})
	.attr("y", function(d,i){
		console.log(mapRect(i))
		return windowHeight+100;
		})
	.text(function(d){
		return d.subject;
	})
	.attr("fill","darkgray");

	// if (rectClicked==true){
	d3.selectAll(".rectsAre")
	.transition()
	.duration(100)
	.attr("y", function(d,i){
		return mapRect(i); //if i want claims on bottom
	});
	d3.selectAll(".rectsAre")
	.transition()
	.duration(200)
	.delay(300)
	.attr("width", function(d,i){
		return d.freq*LEGEND_SCALE;
	});

	d3.selectAll(".textsAre")
	.transition()
	.delay(800)
	.attr("x", function(d){
		return d.freq*LEGEND_SCALE+5;		
	})
	.attr("y", function(d,i){
		return mapRect(i)+5;
	})

	// }
})
}
//Move SVG elements to the end of their container,
//so they appear "on top".
var moveToFront = function() { 
	this.parentNode.appendChild(this); 
}

var angles = [];
var first = [];
var r = [];
var calcX=[];
var calcY=[];
var radiusIs = [];
var allCodes = [];	
var temp = [];
var thisThing;
var whatRadius = [];
var myVar;
var firstLoadVar;
var secondLoadVar;
var ready = 0;

var connDataLength;
firstVariable();
function firstVariable(){
	d3.tsv("connectionfreqcodes_top25.txt", function(error, cData) {
		connDataLength = cData.length;
	})
}
////PROBLEM OF GETTING THIS VARIABLE BEFORE RUNNING OTHER FUNCTIONS
firstLoadVar = setInterval(function(){ 
	if (connDataLength>0){
	if (firstLoad<connDataLength-1){
	d3.tsv("connectionfreqcodes_top25.txt", function(error, cData) {
	firstLoad++; 
	if (firstLoad>=0){
	storeInnerSubjs(cData[firstLoad].codeName, firstLoad);		
	}
	})
	}
	else {
	runOnce();
	clearInterval(firstLoadVar);
	}
}
},1);	

function runOnce(){
	runInnerCircles();
	runOuterCircles();
	processBigs(oneBig,indexBig);
	
// makeGraphsLittle();
}
var countLittleCircle = 0;
var littleCircIndex;
var littleCircChecked = [];
var circleFreq = [];
function runInnerCircles(){

d3.tsv("connectionfreqcodes_top25.txt", function(error, cData) {
for (i = 0; i < cData.length;i++) {
	allCodes.push(cData[i].codeName);
	angles.push(holdAngles[i]);
	radiusIs.push(radius_levels[storeLengths[i]]);
	circleFreq.push(cData[i].freq);
}

for (i=0; i<allCodes.length; i++){
	// first.push(allCodes[i].split(","));
	// if (first)
	r.push(allCodes[i].split(","));
}
// var plottedCircle = vis.selectAll("circlePlotted")
// 	.data(outer_level)
// 	.enter()
// 	.append("circle")
// 	.attr("class","circlePlotted")
// 	.attr("cx",width/2)
// 	.attr("cy",height/2)
// 	.attr("r", 310)
// 	.attr("fill","none")
// 	.attr("stroke","lightgray")
// 	.attr("stroke-opacity",".1")
// 	.attr("stroke-width",10);
// var plottedCircle = vis.selectAll("circlePlotted")
// 	.data(outer_level)
// 	.enter()
// 	.append("circle")
// 	.attr("class","circlePlotted")
// 	.attr("cx",width/2)
// 	.attr("cy",height/2)
// 	.attr("r", 440)
// 	.attr("fill","none")
// 	.attr("stroke","lightgray")
// 	.attr("stroke-opacity",".1")
// 	.attr("stroke-width",20);

// 	plottedCircle
// 	.transition()
// 	.duration(2000)
// 	.attr("stroke-width",200)
// 	.attr("r",650);

// <circle class="circlePlotted" cx="718.5" cy="368.5" r="790" fill="none" stroke="lightgray" stroke-width="500" style="
//     stroke-opacity: .2;
//     -webkit-box-shadow: 0px 0px 5px 1px rgba(255, 255, 255, .1);   
// "></circle>





var ringCircle = vis.selectAll("ringCircle")
	.data(conn_levels)
	.enter()
	.append("circle")
	.attr("class",function(d,i){ return "ringCircle"+d; })
	.attr("cx",width/2)
	.attr("cy",height/2)
	.attr("r", function(d){
		return d;
	})
	.attr("fill","none")
	.attr("opacity",.1)
	.attr("stroke","lightgray")
	.attr("stroke-width",.5)

var inCircle = vis.selectAll("inCircle")
	.data(cData)
	.enter().append("circle")
	.attr("class", function(d,i){ 
		calcX.push(width*0.5+scaling*radiusIs[i]*Math.cos(angles[i]));
		calcY.push(height*0.5+scaling*radiusIs[i]*Math.sin(angles[i]));
		whatRadius.push(Math.log(d.freq+2.0)*freqscale/2);
		return "inCircle"+i; 
	})
	.attr("cx", function(d,i){
		return width*0.5+scaling*radiusIs[i]*Math.cos(angles[i]);
	})
	.attr("cy", function(d,i){ 
		return height*0.5+scaling*radiusIs[i]*Math.sin(angles[i]);
	})
	.attr("r", function(d){
		return (Math.log(d.freq+2.0)*freqscale/2);
	})
	.attr("fill", "gray")
	.attr("opacity",.1)
	.attr("stroke","white")
	.attr("stroke-width",1)
	.on("mouseover", function(d,i){
		d3.select(this)
		.attr("opacity", .9);
		index = i;
		allOut(d.codeName, index); //FIX WHAT THING IS NOW
		})
	.on("mouseout", function(d,i){
		console.log(countLittleCircle%2==0)
		if(countLittleCircle%2==0){
		d3.select(this)
		.attr("opacity",.1)
		removeOutwardLines(d.codeName, i); //FIX CODENAME
		}
	})

	.on("click", function(d,i){
		console.log("clicked little circle for books")
		// d3.select(this)
		// .each(moveToFront)
//APPLY THIS DOWN LOW
// d3.selectAll("line.hey378").transition().attr("stroke","black")

		console.log(d.codeName+"d.codeName on click of little circle")
		countLittleCircle++;
		console.log(countLittleCircle%2+"countLittleCircle")
		littleCircChecked.length=0;

	if (countLittleCircle%2==0){

		d3.select(this)
		.transition()
		.attr("fill","grey")
		.attr("opacity",.1)
		removeOutwardLines(d.codeName, i); //FIX CODENAME
		d3.select("#container").transition().style("opacity", 1);

		d3.selectAll(".mouseoverText").remove();	
		hideBooks();			
	}
	else if (countLittleCircle%2==1){
		d3.select("#container")
		.style("pointer-events","none")
		// d3.select("#hideContainer")
		.transition()
		.style("opacity", ".3");
		// d3.select()

		d3.select(this)
		.transition()
		.attr("fill","yellow");
		// .style("z-index",1001)
		littleCircChecked.push(d.codeName);
		littleCircIndex = i;

		books(d.codeName,i); 
	}
	});


makeGlyph();    
// $('#container').click(function(d,i) {
// d3.select("#container").transition().style("opacity", 1);
// console.log("clicked container")
// d3.selectAll("inCircle"+i)
// 		.transition()
// 		.attr("fill","grey")
// 		d3.select("#booksColumn.selected").classed("selected", false);	
// 		d3.selectAll(".mouseoverText").remove();	
// 		hideBooks();
// });
function makeGlyph(){
myVar = setInterval(function(){ 
if (tigReggib<connDataLength-1){
	tigReggib++; 
	runLinesOut(cData[tigReggib].codeName, tigReggib); //FIX CODENAME
}
else {}
},1);
if (tigReggib>=connDataLength-1){
	clearInterval(myVar);
}
}
})
}

var thisIs = [];
var otherThis = [];
var storeLengths = [];
var countLengths = {};
var jumps = {};
var anglesAre = [];
var holdAngles = [];

var countIt = 0;
var thisCircle;
function storeInnerSubjs(arrayOfSubjs, index){

otherThis = arrayOfSubjs.split(",");
storeLengths.push(otherThis.length); //now this is "q"

countLengths[otherThis.length] = countLengths[otherThis.length] ? countLengths[otherThis.length]+1 : 1; //now this is counters

checkLengths(otherThis,index); //here we finish counters array and create the new jumps thing
}
var stop;
function checkLengths(otherThis,index){
for (i=0; i<MAX_LEVELS; i++){
	anglesAre[i] = 0;

if (countLengths[i]===undefined){
	console.log("undefined");
	countLengths[i] = 0;
}
else {}
	jumps[i]=((Math.PI*2)/countLengths[i]);
}
if (index==connDataLength-1){
	console.log(connDataLength);
	newFunction();
}
}
function newFunction(){
	var onlyThis = 3;
	console.log(jumps[3]);
	for (i=0; i<storeLengths.length; i++){
		anglesAre[storeLengths[i]]+=jumps[storeLengths[i]];
		holdAngles.push(anglesAre[storeLengths[i]]);
	}	
}
// function removeLines(){
// svg.selectAll(".linesIn") //could be just .remove()
	// .transition()
	// .attr("stroke-opacity",.07)
// }
var count = 0;

var theseNums = [];
var boolUnselect = 0;
var checkedToString;
var checkedIndex;
function checked(checkedIt){

boolUnselect = 1;

theseNums = checkedIt;

var chckdLines = vis.selectAll("checkedLines")
	.data(r)
	.enter()
	.append("l")
	.attr("class", function(d,i){
		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){
			if (d[j]<5){
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]);
			}
		}
		newThing.sort(function(a, b){return a-b});
		theseNums.sort(function(a, b){return a-b});
			if(theseNums.toString()==newThing.toString()){
				count = 1;
				console.log(i+"this is index?");
				d3.select("circle.inCircle"+i)
				.transition()
				.attr("opacity", ".9")
				.attr("fill","yellow");
				console.log(checkedIt+"and i"+i)
				// checkedToString = checkedIt.toString();
				checkedIn(checkedIt, i);
				checkedIndex = i;
				matching = 1;
				d3.select("#booksColumn").classed("selected", true);
// $('#booksColumn').tipsy({ 
// 		gravity: 'ne', 
// 		html: true, 
// 		title: function() {
// 		  // var d = this.__data__;
// 		  return circleFreq[checkedIndex]+" linked books";

// 		}
// });



	var howMany = d3.select("#inner")
	.selectAll(".innerText")
   .data(thisIs)
		.enter()
		.append("text")
		.attr("class","innerText")
		////////checked index should change every time right/?????
		.text(function(){
			if(circleFreq[i]>1){
				return circleFreq[i]+" linked books";
			}
			else {
				return circleFreq[i]+" linked book";
			}
		})
		.attr("x",0)
		.attr("y",0);
d3.select("#inner")
.transition()
.style("display","block");
			}

			else {
				 count++;
				d3.select("circle.inCircle"+i)
				.transition()
				.attr("fill", "gray")
				// .attr("opacity",.9);
			}
	if (count%allCodes.length==0){
		console.log("hiding, removing")
		d3.select("#booksColumn.selected").classed("selected", false);	
d3.select("#inner")
.transition()
.style("display","none");
		d3.selectAll(".innerText").remove();	

// d3.selectAll(".innerText")
// .transition()
// .style("display","none");
		d3.selectAll(".mouseoverText").remove();	
		// console.log("hide books")
		hideBooks();			
	}
	else {
		d3.select("#booksColumn.selected").classed("selected", true);	
	}
	// if (matching==0){
	// 	d3.select("#booksColumn.selected").classed("selected", false);
	// 	// console.log("hide books")		
	// 	hideBooks();
	// }

		return "checkedLines";
	})
}

$('#booksColumn').click(function(){
d3.select("#inner")
.transition()
.style("display","none");
		d3.selectAll(".innerText").remove();	

// d3.selectAll(".innerText")
// .transition()
// .style("display","none");

if(littleCircChecked.length==0 && matching==1 || count%allCodes.length>0){
		d3.select("#booksColumn.selected").transition().style("display","none");	
		d3.select("#exit").transition().style("display","block")
	otherBooks(checkedIt,checkedIndex); 
}
})
$('#exit').click(function(){
booksChecked.length = 0;

hideBooks();

// removeOutwardLines(incomingIs, saveClicked);

})
function prepLines(){
	console.log("prep lines");
	for (i=0; i<subjCode.length; i++){
		runLines(subjCode[i]);
	}
}
var linesInG;
function runLines(passSubjNum){
console.log(passSubjNum+"running lines");
var thisNum = passSubjNum;

linesInG = vis.selectAll("linesIn")
	.data(r)
	.enter()
	.append("line")
	.attr("transform", function(d,i){
		return "translate(" + (calcX[i]) + "," + (calcY[i]) + ")";
	})
	.attr("class", function(d,i){

		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){
			if (d[j]<5){
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]);
			}
		}
		for (n=0; n<newThing.length; n++){
			if (thisNum==newThing[n]){
			for (k=0; k<=subjCode.length; k++){
				if(subjCode[k]==thisNum){
				return "linesIn"+subjCode[k];
			}
		}
		}				
		}
	})
	.attr("x1",0)
	.attr("y1",0)
	.attr("x2",function(d,i){
		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){
			if (d[j]<5){
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]);
			}
		}
		for (n=0; n<newThing.length; n++){
			if (thisNum==newThing[n]){
			for (k=0; k<=subjCode.length; k++){
				if(subjCode[k]==thisNum){

		if (subjX[k]>width/2){
			return (subjX[k]-5)-calcX[i]; 	
		}

////////////HERE WE ARE DEALING WITH SUBJECT PLACEMENT

		if (subjX[k]<width/2) {
		// 	return subjX[i]-(d.subject.length*3)-20;
		// }
			if (subjTextInside[k].length > 11){
			return ((subjX[k]-(subjTextInside[k].length*3)-49)+wordWidth[k])-calcX[i];
			}
			if (subjTextInside[k].length<=11 &&subjTextInside[k].length>6){
			return ((subjX[k]-(subjTextInside[k].length*3)-19)+wordWidth[k])-calcX[i];
			}
			else{
			return ((subjX[k]-(subjTextInside[k].length*3)-14)+wordWidth[k])-calcX[i];			
			}
		}

		// if (subjX[k]==width/2){
		// 	return ((subjX[k]-(subjTextInside[k].length*3)-20)+wordWidth[k])-calcX[i];
		// }




		if(subjX[k]==width/2){
			return (subjX[k]-(subjTextInside[k].length*3-14+wordWidth[k]/4))-calcX[i];
		}

			}
			}
			}				
		}
	})
	.attr("y2",function(d,i){
		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){
			if (d[j]<5){
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]);
			}
		}
		for (n=0; n<newThing.length; n++){
			if (thisNum==newThing[n]){
			for (k=0; k<=subjCode.length; k++){
				if(subjCode[k]==thisNum){

		if (subjY[k]>height/2){
			return subjY[k]-calcY[i]-11; 	
		}
		if (subjY[k]<height/2){
			return subjY[k]-calcY[i]+5;
		}
		if(subjY[k]==height/2){
			return subjY[k]-calcY[i]+3;			
		}




				// return subjY[k]-calcY[i]+6;
			}
			}
			}				
		}
	})
	.attr("stroke",function(d,i){
		var newThing = [];
		for (j=0; j<allCodes[i].length; j++){
			if (d[j]<5){
				newThing.push(1);
			}
			if (d[j]>=5){
				newThing.push(d[j]);
			}
		}
		for (n=0; n<newThing.length; n++){
			if (thisNum==newThing[n]){
		var whichLoc;
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==thisNum){
				whichLoc = subjLoc[k];
		return colors[whichLoc];
			}	
		}
	}
}
	})
	.attr("opacity",.4)
	.attr("stroke-width",1);
}

function removeRunnedLines(passSubjNum){
console.log(passSubjNum+"removing runned lines");
var thisNum = passSubjNum;
d3.selectAll(".linesIn"+passSubjNum)
	.transition()
	// .duration(10)
	// .attr("opacity",0)
	.attr("x2",0)
	.attr("y2",0)
}

//for litte circles
function runLinesOut(arrayOfSubjs, index){

thisIs = arrayOfSubjs.split(",");

thisCircle = index;
var justOne = thisIs[0];
var grabIt = [];
var newG = vis.selectAll("linesOut")
	.data(thisIs)
	.enter()
	.append("line")
	.attr("transform", function(d,i){
		return "translate(" + (calcX[thisCircle]) + "," + (calcY[thisCircle]) + ")";
	})
	.attr("class", "hey"+thisCircle)//"linesOut")
	.attr("x1", 0)
	.attr("y1",0)
	.attr("x2",0)
	.attr("y2",0)
	.attr("stroke",function(d,i){
					if (d<5){
						d = 1;
					}
					else if (d>=5){
						d = d;
					}	

		var whichLoc;
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
				whichLoc = subjLoc[k];
				// console.log(subjCode[k]+"subj code all out")
				return colors[whichLoc];
			}	
		}

		// return "lightgray";
	})
	.attr("stroke-width",1)
	.attr("opacity",.6);
	d3.selectAll("line.hey"+thisCircle)
		.transition()
		.attr("x2",function(d,i){
			if (d<5){
				d = 1;
			}
			else if (d>=5){
				d = d;
			}		
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
					return (subjX[k]-calcX[thisCircle])/(300/whatRadius[thisCircle]);
				}
			}
		})
		.attr("y2",function(d){
					if (d<5){
						d = 1;
					}
					else if (d>=5){
						d = d;
					}	
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
					return (subjY[k]-calcY[thisCircle])/(300/whatRadius[thisCircle]);
				}
			}
	})
}



//this is for matched lines
var newG;
function checkedIn(arrayOfSubjs, index){

thisIs = arrayOfSubjs;

thisCircle = index;
console.log(thisIs+"checkedIn")
var justOne = thisIs[0];
var grabIt = [];
var mouseText = vis.selectAll("mouseoverText")
	.data(thisIs)
	.enter()
	.append("text")
	.attr("class","mouseoverText")
	.attr("transform", function(d,i){
		return "translate(" + (calcX[thisCircle]+1) + "," + (calcY[thisCircle]-3) + ")";
	})
	.attr("fill","black")
	.text(circleFreq[thisCircle])
// 	.text(function(){
// 		if (circleFreq[thisCircle]>1){
// 			return circleFreq[thisCircle]+" books"
// 	}
// 		else {
// 			return circleFreq[thisCircle]+" book"
// 	}
// });



newG = vis.selectAll("checkedLinesOut")
	.data(thisIs)
	.enter()
	.append("line")
	.attr("transform", function(d,i){
d3.selectAll(".linesIn"+d)
.transition()
.attr("opacity",.1);

		return "translate(" + (calcX[thisCircle]) + "," + (calcY[thisCircle]) + ")";
	})
	.attr("class","checkedLinesOut")
	.attr("opacity",1)
	.attr("x1", 0)
	.attr("y1",0)
	.attr("x2",function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	
		for (k=0; k<subjCode.length; k++){
			if (subjCode[k]==d){

				if (subjX[k]>width/2){
					return (subjX[k]-5)-calcX[thisCircle]; 	
				}

//////////////HERE WE ARE DEALING WITH SUBJECT PLACEMENT

			if (subjTextInside[k].length > 11){
			return ((subjX[k]-(subjTextInside[k].length*3)-49)+wordWidth[k])-calcX[thisCircle];
			}
			if (subjTextInside[k].length<=11 &&subjTextInside[k].length>6){
			return ((subjX[k]-(subjTextInside[k].length*3)-19)+wordWidth[k])-calcX[thisCircle];
			}
			if(subjTextInside[k].length<=6) {
			return ((subjX[k]-(subjTextInside[k].length*3)-14)+wordWidth[k])-calcX[thisCircle];
			}

		// if (subjX[k]<width/2){
		// 	return ((subjX[k]-(subjTextInside[k].length*3)-20)+wordWidth[k])-calcX[i];
		// }
		if(subjX[k]==width/2){
			return ((subjX[k]-(((subjTextInside[k].length*3)-14)+wordWidth[k])/4))-calcX[thisCircle];
		}



}
}
})



		// if (subjX[k]<width/2){
		// 	return ((subjX[k]-(subjTextInside[k].length*3)-20)+wordWidth[k])-calcX[thisCircle];
		// }
		// if(subjX[k]==width/2){
		// 	return ((subjX[k]-(((subjTextInside[k].length*3)-20)+wordWidth[k])/4))-calcX[thisCircle];
		// }


	.attr("y2",function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	
		for (k=0; k<subjCode.length; k++){
			if (subjCode[k]==d){
		if (subjY[k]>height/2){
			return subjY[k]-calcY[thisCircle]-11; 	
		}
		if (subjY[k]<height/2){
			return subjY[k]-calcY[thisCircle]+5;
		}
		if(subjY[k]==height/2){
			return subjY[k]-calcY[thisCircle]+3;			
		}
		}
		}
	})
	.attr("stroke",function(d,i){
		var whichLoc;
					if (d<5){
						d = 1;
					}
					else if (d>=5){
						d = d;
					}	
			for (k=0; k<subjCode.length; k++){
				if (subjCode[k]==d){
				whichLoc = subjLoc[k];
				// console.log(whichLoc+"whichLoc all out")
				return colors[whichLoc];
			}	
		}
	})
	.attr("stroke-width",1);
}

function allOut(arrayOfSubjs, index){
thisIs = arrayOfSubjs.split(",");
thisCircle = index;

var justOne = thisIs[0];
var grabIt = [];
var mouseText = vis.selectAll("mouseoverText")
	.data(thisIs)
	.enter()
	.append("text")
	.attr("class","mouseoverText")
	.attr("transform", function(d,i){
		return "translate(" + (calcX[thisCircle]+6) + "," + (calcY[thisCircle]-5) + ")";
	})
	.attr("fill","black")
	.text(circleFreq[thisCircle]);

// var howMany = d3.select("#inner")
// 	.selectAll(".innerText")
//    .data(checkedIt)
// 		.enter()
// 		.append("text")
// 		.attr("class","innerText")
// 		////////checked index should change every time right/?????
// 		.text(circleFreq[i]+" linked books")
// 		.attr("x",0)
// 		.attr("y",0);
// d3.select("#inner")
// .transition()
// .style("display","block");



var newG = vis.selectAll("linesOut")
	.data(thisIs)
	.enter()
	.append("line")
	.attr("class", "hey"+thisCircle)//"linesOut")
	.attr("transform", function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	

		var whichLoc;
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
				whichLoc = subjLoc[k];
	d3.selectAll(".surroundingPoints"+subjCode[k])
	.transition()
	// .attr("height",10)
	.attr("stroke", colors[whichLoc]);
			}	
		}
		return "translate(" + (calcX[thisCircle]) + "," + (calcY[thisCircle]) + ")";
	})
	.attr("x1", 0)
	.attr("y1",0)
	.attr("stroke",function(d,i){
					if (d<5){
						d = 1;
					}
					else if (d>=5){
						d = d;
					}	

		var whichLoc;
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
				whichLoc = subjLoc[k];
				return colors[whichLoc];
			}	
		}
	})
	.attr("stroke-width",1)
	.attr("x2",function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	
		for (k=0; k<subjCode.length; k++){
			if (subjCode[k]==d){

		if (subjX[k]>width/2){
			return (subjX[k]-4)-calcX[thisCircle]; 	
		}
////////////another place to deal with subject placement
			if (subjTextInside[k].length > 11){
			return ((subjX[k]-(subjTextInside[k].length*3)-50)+wordWidth[k])-calcX[thisCircle];
			}
			if (subjTextInside[k].length<=11 &&subjTextInside[k].length>6){
			return ((subjX[k]-(subjTextInside[k].length*3)-20)+wordWidth[k])-calcX[thisCircle];
			}
			else {
			return ((subjX[k]-subjTextInside[k].length*3-15)+wordWidth[k])-calcX[thisCircle];				
			}
		if(subjX[k]==width/2){
			return ((subjX[k]-(((subjTextInside[k].length*3)-15)+wordWidth[k])/4))-calcX[thisCircle];
		}
			}
		}
	})
	.attr("y2",function(d,i){
		if (d<5){
			d = 1;
		}
		else if (d>=5){
			d = d;
		}	
		for (k=0; k<subjCode.length; k++){
			if (subjCode[k]==d){
		if (subjY[k]>height/2){
			return subjY[k]-calcY[thisCircle]+5; 	
		}
		if (subjY[k]<height/2){
			return subjY[k]-calcY[thisCircle]+5;
		}
		if(subjY[k]==height/2){
			return subjY[k]-calcY[thisCircle]+5;			
		}
		}
		}
	});
}
function removeOutwardLines(codes, thisCirc){
var outToText = vis.selectAll("outText") //not outText
d3.selectAll(".outText").remove();
d3.selectAll(".mouseoverText").remove();

d3.selectAll(".hey"+thisCirc) //associated lines
	.transition()
	.attr("x2",function(d,i){
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
					return (subjX[k]-calcX[thisCirc])/(300/whatRadius[thisCirc]);
				}
				if(d==2||d==3||d==4){
					d=1;
				if (subjCode[k]==d){
					return (subjX[k]-calcX[thisCirc])/(300/whatRadius[thisCirc]);		
					}			
				}
			}
	})
	.attr("y2",function(d,i){
			for (k=0; k<=subjCode.length; k++){
				if (subjCode[k]==d){
					return (subjY[k]-calcY[thisCirc])/(300/whatRadius[thisCirc]);
				}
				if(d==2||d==3||d==4){
					d=1;
				if (subjCode[k]==d){
					return (subjY[k]-calcY[thisCirc])/(300/whatRadius[thisCirc]);		
					}			
				}
			}
		})
}

var incomingSplit = [];
var incomingIs = [];
var whichBooks = [];
var manyBooks = [];
var manyIds = [];
var manyCodes = [];
var dividedCodes = [];
var saveId = [];

function loadBooks(){
d3.tsv("all_id_codes_title_top25.txt", function(error, data) {
for (j=0; j<data.length; j++){
	manyBooks.push(data[j].title);
	manyIds.push(data[j].id);
	manyCodes.push(data[j].code);
}
for (i=0; i<manyCodes.length; i++){
	dividedCodes.push(manyCodes[i].split(","));
}
for (j=0; j<dividedCodes.length; j++){
	codeSorted.push((dividedCodes[j].sort(function(a, b){return a-b})).toString());
}
})
}

var testing;
var newChecked = [];
var codeSorted = [];
var otherFirst = [];
var booksChecked = [];
var overFour = 0;
var bookColors = [];
var manyBookColors = {};

function otherBooks(checkedTo, thisCircle){
console.log("otherBooks"+checkedTo+"i"+thisCircle);

for (i=0; i<checkedIt.length; i++){
	booksChecked.push(checkedIt[i])
}

booksChecked.sort(function(a, b){return a-b});
		console.log(booksChecked+"books checked sorted")

for (j=0; j<booksChecked.length; j++){
		if (booksChecked[j]>4){
			overFour = 1;
		}
	}
if (overFour==1){
for (i=0; i<codeSorted.length; i++){
	if (codeSorted[i]==booksChecked.toString()){
		whichBooks.push(manyBooks[i]);
		saveId.push(manyIds[i]);
	}
}
}

////SPLICE IN A 2 AND COMPARE
for (j=0; j<booksChecked.length; j++){

if (booksChecked[j]==1){
	booksChecked.splice(j,1,"2")
	for (i=0; i<codeSorted.length; i++){
		if (codeSorted[i]==booksChecked.toString()){
			whichBooks.push(manyBooks[i]);
			saveId.push(manyIds[i]);
		}
	}
	}
if (booksChecked[j]==2){
	booksChecked.splice(j,1,"3")
	for (i=0; i<codeSorted.length; i++){
		if (codeSorted[i]==booksChecked.toString()){
			whichBooks.push(manyBooks[i]);
			saveId.push(manyIds[i]);
		}
	}		
	}
if (booksChecked[j]==3){
	booksChecked.splice(j,1,"4")
	for (i=0; i<codeSorted.length; i++){
		if (codeSorted[i]==booksChecked.toString()){
			whichBooks.push(manyBooks[i]);
			saveId.push(manyIds[i]);
		}
	}		
	}
}
updateHoverbox(whichBooks, saveId);
console.log(whichBooks.length)
}

var matchingArray = [];
var matched = [];
var saveClicked;
function books(incoming, thisCircle){

		d3.select("#booksColumn").style("display","none");	
		d3.select("#exit").transition().style("display","block")
//APPLY THIS DOWN LOW
// d3.selectAll("line.hey"+thisCircle).each(fadeToFront);
// transition().attr("stroke","black")
saveClicked = thisCircle;
clicked = 0;
incomingIs = incoming.toString();
incomingSplit = incomingIs.split(",");
			for (j=0; j<manyCodes.length; j++){
				if (manyCodes[j]==incomingSplit){ 
					// console.log(manyCodes[j]+" matching "+incomingSplit)
					whichBooks.push(manyBooks[j]);
					saveId.push(manyIds[j]);
					updateHoverbox(manyBooks[j], manyIds[j]);
				}
			}

}

//Setup hover box
 hoverbox = d3.select("#hoverbox");
 var itsHeight;
 var clickOut = false;
var updateHoverbox = function(theseBooks, whichCode) {

d3.select("#hoverbox").style("width","12em");

var bookList = hoverbox
   .selectAll(".listBooks")
   .data(whichBooks)
		.enter()
		.append("text")
		// .append("p")
		.attr("class","listBooks")
		.text(function(d){
			return d;
		})
		.attr("x",0)
		.attr("y",0)
		.on("click", function(d,i){
			 window.open('http://clio.columbia.edu/catalog/'+saveId[i]+'.html');
		});

$('#hoverbox').tipsy({ 
		gravity: 'se', 
		html: true, 
		title: function() {
	return "Click for Columbia Library Listing"

		}
});
	itsHeight = $("#hoverbox").height();

};
$('#graphIcon').tipsy({
	gravity: 'sw',
	html:true,
	title: function(){
		return "Subject Frequency"
	}
})
function hideBooks(){

removeOutwardLines(littleCircChecked, littleCircIndex); //FIX CODENAME
			d3.select("circle.inCircle"+saveClicked)
			.transition()
			.attr("fill","grey")
			.attr("opacity",.1);
clickOut = false;
littleCircChecked.length=0;
countLittleCircle = 0;
whichBooks.length = 0;
saveId.length = 0;


d3.select("#container")
	.transition()
	.style("opacity", "1");
d3.select("#container").style("pointer-events","auto");

d3.select("#booksColumn").transition().style("display","block");	
d3.select("#exit").transition().style("display","none")

d3.selectAll(".listBooks").remove();

d3.select("#hoverbox").transition().style("width","0em");

}

$("#clearAll").on("click", function(){
clearEverything();
})
function clearEverything(){
	hideBooks();
for (i=0; i<calcX.length; i++){
	d3.selectAll("text.mouseoverText"+i).remove();
	d3.selectAll("circle.inCircle"+i)
		.transition()
		.attr("fill", "gray")
		.attr("opacity",.1);

	//.remove();
}
	for (z=0; z<subjCode.length; z++){
		d3.selectAll(".linesIn"+subjCode[z]).remove();
// 	.transition()
// 	.attr("x2",0)
// 	.attr("y2",0)

storeClicks[z] = 0;
		// .transition()
		// .attr("opacity",0)


// for (i=0; i<checkedIt.length; i++){
// d3.selectAll(".linesIn"+checkedIt[i])
// 	.transition()
// 	.attr("x2",0)
// 	.attr("y2",0)
// }

	d3.selectAll(".surroundingPoints"+subjCode[z])
		.transition()
		.attr("y", subjY[z]+5)
		.attr("height",.1)
}
d3.selectAll("line.checkedLinesOut")
	.transition()
	.attr("x2",0)
	.attr("y2",0)


checkedIt.length=0;
booksChecked.length = 0;
whichBooks.length = 0;
checkedIndex = 0;
d3.select("#booksColumn").transition().style("display","block");
d3.select("#booksColumn.selected").classed("selected", false);		
d3.select("#exit").transition().style("display","none")

	//clear checked lines
	//clear runned lines
	//clear selected circles
	//clear selected subjects

	//change clicked count to start over again
	//clear book box's info / highlighting
}


















var fadeToFront = function() {
 
	//Select this element, that we want to move to front
	var orig = d3.select(this);
	var origNode = orig.node();
	
	//Clone it, and append the copy on "top" (meaning, at the end of
	//the parent element, which is <svg> in this case)
	var dupe = d3.select(origNode.parentNode.appendChild(origNode.cloneNode(true), origNode.nextSibling));
 
	//Make the new element transparent immediately, then fade it in over time
	dupe.style("opacity", 0.0)
		.transition()
		.duration(speed)
		.style("opacity", 1.0)
		.each("end", function() {
 
			//When the fade-in is complete, add the click event…
			d3.select(this).on("click", function() {
				d3.select(this).each(fadeToFront);
			});
 
			//…and delete the original
			orig.remove();
 
		});
 
}
////////////////////////////////////////////////////
////IF D.FREQ IS GREATER THAN 600, PREPROCESS BOOK LISTs
//"1,1"	40719 -> no
// "1,1,1"	18603
// "1,1,1,1"	24833
// "1,21"	8501
// "1,1,1,1,1"	13625
// "1,21,2"	4012
// "5,20"	3346
// "1,1,1,1,1,1"	1909
// "5,12"	1567
// "9,7"	1394
// "16,7"	516
////////////////////////////////////////////////////
var oneBig = "1,21,2";
var indexBig = 2;
var bigBooks = [];
var saveBigIds = [];
var incomingBig;
var splitBig;
// processBigs(oneBig,indexBig);
function processBigs(oneBig, indexBig){

incomingBig = oneBig.toString();
splitBig = incomingBig.split(",");
			for (j=0; j<manyCodes.length; j++){
				if (manyCodes[j]==splitBig){ 
					bigBooks.push(manyBooks[j]);
					saveBigIds.push(manyIds[j]);
				}
			}

}

var specialCirc = 393;
var p0 = [width/2, height/2, windowHeight],
    // p1 = [width/2+conn_levels[6], height/2, 100],
    // p2 = [width/2+conn_levels[5], height/2, 100];
    // p3 = [width/2+conn_levels[4], height/2, 100];
    // p4 = [width/2+conn_levels[3], height/2, 100];
    // p5 = [width/2+conn_levels[2], height/2, 100];
    p1 = [width/2+conn_levels[2], height/2, 100],
    p2 = [width/2+conn_levels[3], height/2, 100];
    p3 = [width/2+conn_levels[4], height/2, 100];
    p4 = [width/2+conn_levels[5], height/2, 100];
    p5 = [width/2+conn_levels[6], height/2, 100];
    //going to special circle
    p6 = [width/2+conn_levels[4], height/2, 100];
    var p7; //= [width/2+conn_levels[4], height/2, 100];
    // p7 = [calcX[specialCirc], calcY[specialCirc], 100];
	p8 = [width/2, height/2, windowHeight];
	var specialSubj1 = 19;
	var specialIndex1;
	var specialSubj2 = 5;
	var specialIndex2;
	var specialSubj3 = 12;
	var specialIndex3;

    var clickedSubline = false;

$("#subline").click(function(){
	console.log(clickedSubline+"clickedSubline")
	clickedSubline = !clickedSubline;
	if (clickedSubline){
	$("#clearAll").animate().css('margin-top', '4.5em');	
	}
	else{
	$("#clearAll").animate().css('margin-top', '.01em');
	}
	$("#about").toggle("fast");
//first transition
	d3.select("#about").on("click",function(){
	svg.call(transition, p0, p1);
	// svg.call(transition, p6,p6)
	})
})

var center = [width / 2, height / 2];
function transition(svg, start, end) {
var  i = d3.interpolateZoom(start, end);

  vis
      .attr("transform", transform(start))
    .transition()
      // .delay(250)
      .delay(1000)

      .duration(i.duration * 2)
      .attrTween("transform", function() { return function(t) { return transform(i(t)); }; })
      .each("end", function() { 
if (end==p1){

$(".introZoom").animate().css("opacity",1).show("fast", function(){
	$("#intro4").show("fast", function(){
		$(".introZoom").animate().css("height","inherit");		
	});
});
// height: inherit;

	d3.select(".ringCircle"+(p1[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.duration(1000)
	.attr("stroke-width",1)
// }
    .each("end", function(){
 		// $("#intro4").hide("fast");
      	svg.call(transition,p1,p2);
     })
 }
if(end==p2){
$("#intro5").show("fast");
	d3.select(".ringCircle"+(p2[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.duration(500)
	.attr("stroke-width",1)
	.each("end",function(){
      	svg.call(transition,p2,p3);
    })
}
if(end==p3){
	$("#intro6").show("fast");

	d3.select(".ringCircle"+(p3[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.duration(500)
	.attr("stroke-width",1)
	.each("end",function(){
      	svg.call(transition,p3,p4);
      })
}
if(end==p4){
	$("#intro7").show("fast");

	d3.select(".ringCircle"+(p4[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.duration(500)
	.attr("stroke-width",1)
	.each("end",function(){
      	svg.call(transition,p4,p5);
      })
}
if(end==p5){
	$("#intro8").show("fast");
	d3.select(".ringCircle"+(p5[0]-width/2))
	.transition()
	.attr("opacity",1)
	.attr("stroke-width",3)
	.transition()
	.duration(500)
	.attr("stroke-width",1)
	.each("end",function(){
	$("#intro4, #intro5, #intro6, #intro7, #intro8").hide("fast");
	$("#intro9").show("slow"); //each circle represents a collection of books related to a unique set of subjects

      	svg.call(transition,p5,p6);
      });
      	console.log("ok")
}



	// <div id="intro9" style="display: none;">
	// 			<p>Each circle represents a collection of books related to a unique set of subjects</p>
	// </div>
	// <div id="intro10" style="display: none;">
	// 			<p>Its size relates to how many books it contains</p>
	// </div>
	// <div id="intro11" style="display: none;">
	// 			<p>If you mouseover one circle, you will see lines spike out towards the related subjects</p>
	// </div>




if(end==p6){

   p7 = [calcX[specialCirc], calcY[specialCirc], 100];

  d3.select("circle.inCircle"+specialCirc)
  .transition()
  .attr("opacity","1")
  .each("end",function(){

   d3.selectAll("line.hey"+specialCirc) //	.attr("class", "hey"+thisCircle)//"linesOut"
      	.transition()
      	.attr("opacity",1)
      	// .delay(2000)
  	.each("end",function(){
      	svg.call(transition,p6,p7);
      });  	
  })
}
if(end==p7){
	//here we will do something like make 
	//then we also want to zoom out
//ALLMOUSEOVERTEXT  d3.select("circle.inCircle"+specialCirc)
  d3.select("circle.inCircle"+specialCirc)
  .transition()
  .duration(1000)
  .attr("stroke","white")
  .attr("stroke-width",function(){
  		$("#intro10").show("fast"); //SIZE
		return 4; 
	})
  .transition()
  .duration(1000)
  .attr("stroke-width",1)
  .each("end",function(){
  	$("#intro11").show("fast"); //SUBJECTS

 	allOut(allCodes[specialCirc], specialCirc); //FIX WHAT THING IS NOW

	d3.selectAll(".mouseoverText")
		.transition()
		.delay(3000)
		.duration(2000)
		.attr("fill","black")
		.each("end",function(){
			svg.call(transition,p7, p8);  
				d3.selectAll(".mouseoverText")
				.transition()
				.attr("fill","black")
				.attr("stroke","none");
  		})
	})
}





if(end==p8){
	$("#intro9, #intro10, #intro11").hide("fast");
//FIGURE OUT HOW TO ANIMATE THE CSSS HERE I THINK?
$(".introZoom").animate({
width:"16%",
left:"0.6in",
top:"300px",
}).show("fast");
	// ).css("width:16%","left:98px","top:300px").show("fast");

// $( "#go" ).click(function() {
//   $( "#block" ).animate({
//     width: "70%",
//     opacity: 0.4,
//     marginLeft: "0.6in",
//     fontSize: "3em",
//     borderWidth: "10px"
//   }, 1500 );
// });








// $(".introZoom").animate().css("width:16%","left","98px";"top","300px").show("fast");
// width: 16%;
// left: 98px;
// top: 300px;





d3.selectAll("line.hey"+specialCirc)
	.transition()
	.attr("x2",0)
	.attr("y2",0);
d3.selectAll(".mouseoverText").remove();
d3.select("circle.inCircle"+specialCirc)
  	.transition()
  	.attr("opacity",".1")
  	.each("end",function(){
  	$("#intro12").show("fast"); //SUBJECTS

///////////////////first subject

//SELECT ONE SUBJECT "CLICK IT"

			matching = 0;

for (i=0; i<subjCode.length; i++){ 
	if (subjCode[i]==specialSubj1){ 
		specialIndex1 = i; 
	}
	if (subjCode[i]==specialSubj2){ 
		specialIndex2 = i; 
	}
	if (subjCode[i]==specialSubj3){ 
		specialIndex3 = i; 
	}
}

			runLines(specialSubj1);
			checkedIt.push(specialSubj1);
			checked(checkedIt);
		d3.select(".surroundingPoints"+specialSubj1)
			.transition()
			.delay(2000)
			.duration(2000)
			.attr("y", subjY[specialIndex1]-10)
			.attr("height",14)
			.attr("stroke", colors[subjLoc[specialIndex1]])
		.each("end",function(){
			runLines(specialSubj2);
			checkedIt.push(specialSubj2);
			checked(checkedIt);
		d3.select(".surroundingPoints"+specialSubj2)
			.transition()
			.delay(2000)
			.duration(2000)
			.attr("y", subjY[specialIndex2]-10)
			.attr("height",14)
			.attr("stroke", colors[subjLoc[specialIndex2]])	
			//CHECK THE ADJOINING LINES
			.each("end",function(){
				runLines(specialSubj3);
				checkedIt.push(specialSubj3);
				checked(checkedIt);
				d3.select(".surroundingPoints"+specialSubj3)
					.transition()
					.delay(1000)
					.duration(1000)
					.attr("y", subjY[specialIndex3]-10)
					.attr("height",14)
					.attr("stroke", colors[subjLoc[specialIndex3]])
					.each("end",function(){
						//open books column
  	$("#intro13").show("slow"); //SUBJECTS

d3.select("#inner")
.transition()
.delay(2000)
.duration(2000)
.style("display","none")
.each("end",function(){
	d3.selectAll(".innerText").remove();	
	d3.select("#booksColumn.selected")
		.transition()
		.duration(2000)
		.style("display","none");	
		d3.select("#exit")
		.transition()
		.style("display","block")
		.each("end",function(){
		otherBooks(checkedIt,checkedIndex);
  	$("#intro14").show("fast"); //SUBJECTS		
		})
//then simulate clicking on a book??

})


					})	
			})		
		})

// 		if(storeClicks[i]%2==0){ //if unselected
// 			console.log("clicked off"+storeClicks[i]%2)
// 			d3.select(".surroundingPoints"+d.subjCode)
// 			.transition()
// 			.attr("y", subjY[i]+5)
// 			.attr("height",.1)
// 		//and remove that subject number
// 			for (c=0; c<checkedIt.length; c++){
// 				if (checkedIt[c]==d.subjCode){ // || 2 || 3 || 4
// 				checkedIt.splice(c,1);
// 			}
// 		}
// booksChecked.length = 0;
// bookColors.length = 0;

// d3.selectAll("circle.inCircle"+checkedIndex)
// 	.transition()
// 	.attr("opacity",.1)
// 	.attr("fill","grey");
// d3.selectAll(".checkedLinesOut").remove();
// d3.selectAll(".mouseoverText").remove();
// d3.selectAll(".innerText").remove();

// checked(checkedIt);

// removeRunnedLines(d.subjCode);

// 	}

///////////////////////////ready for next subject?
  	})
}

//by the way maybe i can just do d3.select("ringcircle+end", no ifs)
});

  function transform(p) {
    var k = height / p[2]; //*2;
    return "translate(" + (center[0] - p[0] * k) + "," + (center[1] - p[1] * k) + ")scale(" + k + ")";
  }
  // d3.select("circle.inCircle"+specialCirc).transition().attr("opacity","1")
}




function explainLines(){
 	allOut(allCodes[specialCirc], specialCirc); //FIX WHAT THING IS NOW
	//here we will do something like make 
	//then we also want to zoom out
	var p9 = [width/2, height/2, windowHeight];
    var p10 = [calcX[specialCirc], calcY[specialCirc], 100];
	svg.call(transitionTwo, p10, p9);
}


function transitionTwo(svg, start, end) {
 var i = d3.interpolateZoom(start, end);

  vis
      .attr("transform", transform(start))
    .transition()
      .delay(250)
      .duration(i.duration * 4)
      .attrTween("transform", function() { return function(t) { return transform(i(t)); }; })

  function transform(p) {
    var k = height / p[2]; //*2;
    return "translate(" + (center[0] - p[0] * k) + "," + (center[1] - p[1] * k) + ")scale(" + k + ")";
  }
}



/////////////////////////////////////////
// var center = [width / 2, height / 2];
// function transition(svg, start, end) {
//     var  i = d3.interpolateZoom(start, end);

//   vis
//       .attr("transform", transform(start))
//     .transition()
//       .delay(250)
//       .duration(i.duration * 4)
//       .attrTween("transform", function() { return function(t) { return transform(i(t)); }; })
//       .each("end", function() { 
//       	d3.selectAll("line.hey"+specialCirc) //	.attr("class", "hey"+thisCircle)//"linesOut")
//       	.transition()
//       	.attr("opacity",1)
//       	.each("end", function(){
//       		//make lines go out
//       		explainLines();
//       	})
//       });

//   function transform(p) {
//     var k = height / p[2]; //*2;
//     return "translate(" + (center[0] - p[0] * k) + "," + (center[1] - p[1] * k) + ")scale(" + k + ")";
//   }
//   d3.select("circle.inCircle"+specialCirc).transition().attr("opacity","1")
// }
// function explainLines(){
//  	allOut(allCodes[specialCirc], specialCirc); //FIX WHAT THING IS NOW
// 	//here we will do something like make 
// 	//then we also want to zoom out
// 	var p0 = [width/2, height/2, windowHeight],
//     p1 = [calcX[specialCirc], calcY[specialCirc], 100];
// 	svg.call(transitionTwo, p1, p0);
// }


// function transitionTwo(svg, start, end) {
//  var i = d3.interpolateZoom(start, end);

//   vis
//       .attr("transform", transform(start))
//     .transition()
//       .delay(250)
//       .duration(i.duration * 4)
//       .attrTween("transform", function() { return function(t) { return transform(i(t)); }; })

//   function transform(p) {
//     var k = height / p[2]; //*2;
//     return "translate(" + (center[0] - p[0] * k) + "," + (center[1] - p[1] * k) + ")scale(" + k + ")";
//   }
// }
///////////////////////////



// function transition(svg, start, end) {
//   var center = [width / 2, height / 2],
//       i = d3.interpolateZoom(start, end);

//   vis
//       .attr("transform", transform(start))
//     .transition()
//       .delay(250)
//       .duration(i.duration * 4)
//       .attrTween("transform", function() { return function(t) { return transform(i(t)); }; })
//       .each("end", function() { d3.select(this).call(transition, end, start); });

//   function transform(p) {
//     var k = height / p[2]; //*2;
//     return "translate(" + (center[0] - p[0] * k) + "," + (center[1] - p[1] * k) + ")scale(" + k + ")";
//   }
// }


</script>
</body>
</html>